<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI‑style Code Rewriter • Apple‑inspired</title>

    <!--
      Design notes (Apple‑inspired highlights)
      ---------------------------------------------------------------------
      • Typography: use -apple-system (San Francisco) stack; restrained weights and tracking.
      • Layout: large title + card sections; generous spacing; aligned controls and clear hierarchy.
      • Visuals: dark base + translucent glass (backdrop-blur); subtle glow shadows; hairline dividers.
      • Motion: gentle transitions and scale feedback; honor prefers-reduced-motion.
      • Clarity: fewer visual distractions; a single primary action (Transform).
      • Accessibility: explicit aria-label/roles; good contrast; keyboard shortcuts (Cmd/Ctrl+Enter).
    -->

    <!-- Tailwind config must be declared before the CDN script -->
    <script>
      /*
        Tailwind on CDN: customize fonts and shadows via global tailwind.config.
        Add iOS-like shadows, radii, and an Apple system font stack.
      */
      window.tailwind = window.tailwind || {};
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: [
                '-apple-system',
                'BlinkMacSystemFont',
                'Segoe UI',
                'Roboto',
                'Noto Sans',
                'Helvetica Neue',
                'Arial',
                'sans-serif',
              ],
            },
            boxShadow: {
              ios: '0 10px 30px rgba(0,0,0,0.35), 0 1px 0 rgba(255,255,255,0.06) inset',
            },
            colors: {
              // Apple-like neutral surfaces (approximation)
              surface: {
                50: 'rgba(255,255,255,0.04)',
                100: 'rgba(255,255,255,0.06)',
              },
            },
            transitionTimingFunction: {
              ios: 'cubic-bezier(0.22, 0.61, 0.36, 1)', // iOS ease with slight spring feel
            },
            keyframes: {
              pulseSoft: {
                '0%, 100%': { transform: 'scale(1)', opacity: 1 },
                '50%': { transform: 'scale(0.985)', opacity: 0.9 },
              },
            },
            animation: {
              pulseSoft: 'pulseSoft 1.8s ease-in-out infinite',
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /*
        Additional low-level styles:
        - Glass card (.glass)
        - Hairline divider (.hairline)
      */
      .glass { backdrop-filter: saturate(160%) blur(20px); -webkit-backdrop-filter: saturate(160%) blur(20px); }
      .hairline { border-top: 1px solid rgba(255,255,255,0.06); }

      /* Reduced motion preference: disable non-essential animations */
      @media (prefers-reduced-motion: reduce) {
        .animate-pulseSoft { animation: none !important; }
        * { transition: none !important; }
      }

      /* Focus visibility (a11y) */
      :focus-visible { outline: 2px solid rgba(255,255,255,0.6); outline-offset: 2px; border-radius: 12px; }

      /* Friendlier monospace for code areas */
      textarea, code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

      /* Apple‑style accent button (luminous gradient) */
      .accent-btn { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%); color: #fff; box-shadow: 0 10px 30px rgba(168,85,247,0.25); }
      .accent-btn:hover { filter: brightness(1.05); }
      .accent-btn:disabled { opacity: .6; cursor: not-allowed; }

      /* Colorful progress bar with gentle sweep */
      .progress-track { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.08); }
      .progress-bar { background: linear-gradient(90deg, #34d399, #22d3ee, #60a5fa, #a78bfa, #f472b6); background-size: 300% 100%; animation: gradientShift 4s ease infinite; transition: width .4s cubic-bezier(0.22, 0.61, 0.36, 1), background-position 2.4s linear; }
      @keyframes gradientShift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
    </style>
  </head>

  <body class="min-h-screen bg-black text-white font-sans selection:bg-white/10">
    <!--
      Top navigation — large title + settings on the right
      - Hierarchy: title > controls
      - Content width limited to ~1200px for comfortable reading width
    -->
    <header class="sticky top-0 z-40 bg-black/60 glass backdrop-saturate-150 border-b border-white/10">
      <div class="mx-auto max-w-6xl px-4">
        <div class="flex items-center justify-between h-16">
          <h1 class="text-xl sm:text-2xl tracking-tight font-semibold">
            AI‑style Code Rewriter
          </h1>
          <div class="flex items-center gap-2">
            <button id="openSettingsBtn" class="group inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5" aria-label="Open settings">
              <!-- Simplified, crisper Settings icon (sliders) for better legibility -->
              <svg class="w-4 h-4 opacity-90 group-hover:opacity-100 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <line x1="4" y1="6" x2="20" y2="6"/>
                <line x1="4" y1="12" x2="20" y2="12"/>
                <line x1="4" y1="18" x2="20" y2="18"/>
                <circle cx="9" cy="6" r="2"/>
                <circle cx="15" cy="12" r="2"/>
                <circle cx="7" cy="18" r="2"/>
              </svg>
              <span class="text-sm">Settings</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main area: two columns — input & output -->
    <main class="mx-auto max-w-6xl px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input card -->
        <section class="relative rounded-2xl bg-surface-50/50 border border-white/10 glass shadow-ios">
          <div class="p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-medium opacity-90">Input</h2>
              <div class="text-xs text-white/60">Paste code to restyle</div>
            </div>
            <textarea id="input" class="w-full h-[360px] lg:h-[520px] p-3 sm:p-4 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/30 resize-y" spellcheck="false" aria-label="Input code"></textarea>
          </div>
        </section>

        <!-- Output card -->
        <section class="relative rounded-2xl bg-surface-50/50 border border-white/10 glass shadow-ios">
          <div class="p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-medium opacity-90">Output</h2>
              <div class="flex items-center gap-2">
                <button id="copyBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm" aria-label="Copy output">
                  <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  Copy
                </button>
                <button id="clearBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm" aria-label="Clear output">
                  <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  Clear
                </button>
              </div>
            </div>
            <textarea id="output" class="w-full h-[360px] lg:h-[520px] p-3 sm:p-4 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/30 resize-y" spellcheck="false" aria-label="Output code" readonly></textarea>
          </div>
        </section>
      </div>

      <!-- Action area: Transform button + progress + status -->
      <div class="mt-6 flex flex-col gap-3">
        <!-- Error box (hidden by default) -->
        <div id="errorBox" class="hidden rounded-xl border border-red-500/30 bg-red-400/10 text-red-200 px-4 py-3"></div>

        <div class="flex items-center gap-2">
          <button id="transformBtn" class="inline-flex items-center justify-center rounded-full accent-btn active:scale-[0.98] transition-transform ease-ios px-5 py-3 text-sm font-medium shadow-ios">
            <span id="transformText">Transform</span>
          </button>

          <!-- Thin progress bar -->
          <div class="flex-1 basis-[65%] h-2 rounded-full overflow-hidden progress-track">
            <div id="progressBar" class="h-full w-0 rounded-full progress-bar"></div>
          </div>
          <div id="progressText" class="text-xs text-white/70 w-[110px] text-right">Ready</div>
        </div>

        <p class="text-xs text-white/50">Tip: Press <kbd class="px-1.5 py-0.5 bg-white/10 rounded border border-white/15">⌘/Ctrl</kbd> + <kbd class="px-1.5 py-0.5 bg-white/10 rounded border border-white/15">Enter</kbd> to Transform</p>
      </div>
    </main>

    <!-- Settings drawer (slides from the right) -->
    <div id="settingsPanel" class="fixed inset-0 z-50 hidden" aria-hidden="true">
      <!-- Translucent scrim -->
      <div id="backdrop" class="absolute inset-0 bg-black/50 transition-opacity"></div>

      <!-- Drawer panel -->
      <aside class="absolute right-0 top-0 h-full w-full sm:w-[460px] bg-black/80 glass backdrop-saturate-150 border-l border-white/10 shadow-2xl transform translate-x-full transition-transform ease-ios" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="h-full flex flex-col">
          <div class="flex items-center justify-between p-4 sm:p-5 border-b border-white/10">
            <h3 class="text-lg font-semibold">Settings</h3>
            <button id="closeSettingsBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
              Close
            </button>
          </div>

          <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-5">
            <!--
              Connection settings styled with Apple-like forms:
              - Labels stacked above controls; rounded fields on glassy backgrounds
            -->
            <div>
              <label for="endpoint" class="block text-sm text-white/70 mb-1">Endpoint</label>
              <input id="endpoint" type="text" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="https://api.openai.com/v1/chat/completions" />
              <p class="mt-1 text-xs text-white/50">OpenAI‑compatible Chat Completions endpoint.</p>
            </div>

            <div>
              <label for="model" class="block text-sm text-white/70 mb-1">Model</label>
              <input id="model" type="text" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="gpt-4o-mini / llama‑3.1‑8b‑instruct / qwen2.5‑7b‑instruct" />
            </div>

            <!-- Comment language (controls the language used in generated comments) -->
            <div>
              <label for="commentLang" class="block text-sm text-white/70 mb-1">Comment language</label>
              <select id="commentLang" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="en" selected>English</option>
                <option value="zh">中文（简体）</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <option value="es">Español</option>
                <option value="de">Deutsch</option>
                <option value="fr">Français</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Controls the language of comments the AI adds to your code.</p>
            </div>

            <!-- Comment style (JSDoc / Google / NumPy / reST / Doxygen / Auto) -->
            <div>
              <label for="commentStyle" class="block text-sm text-white/70 mb-1">Comment style</label>
              <select id="commentStyle" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="auto" selected>Auto (language‑aware)</option>
                <option value="jsdoc">JSDoc / TSDoc</option>
                <option value="google">Google (Python)</option>
                <option value="numpy">NumPy (Python)</option>
                <option value="rst">reStructuredText (Python)</option>
                <option value="doxygen">Doxygen / Javadoc (C/C++/Java/C#)</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Pick a documentation style. Auto chooses based on detected language.</p>
            </div>

            <!-- Comment verbosity (Minimal / Standard / Detailed) -->
            <div>
              <label for="commentVerbosity" class="block text-sm text-white/70 mb-1">Comment detail level</label>
              <select id="commentVerbosity" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="minimal">Minimal</option>
                <option value="standard" selected>Standard</option>
                <option value="detailed">Detailed</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Controls how deep the AI goes with docs and inline notes.</p>
            </div>

            <!-- What to include in comments -->
            <div>
              <label class="block text-sm text-white/70 mb-1">Include in comments</label>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeModuleHeader" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Module/file header
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeEdgeCases" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Edge cases & assumptions
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeComplexity" type="checkbox" class="rounded bg-black/60 border-white/20" /> Time/space complexity
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeRationale" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Inline rationale (non‑obvious logic)
                </label>
              </div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-1">
                <label for="temperature" class="text-sm text-white/70">Strength <span class="text-white/40">(强度)</span></label>
                <span id="tempVal" class="text-sm text-white/80">0.2</span>
              </div>
              <!-- iOS-like slider: round thumb + thin track (native range with Tailwind overrides) -->
              <input id="temperature" type="range" min="0" max="2" step="0.1" value="0.2" class="w-full h-2 bg-white/10 rounded-full appearance-none" />
              <p class="mt-1 text-xs text-white/50">Higher → bolder rewrites; lower → conservative.</p>
            </div>

            <div>
              <label for="maxTokens" class="block text-sm text-white/70 mb-1">Max tokens (optional)</label>
              <input id="maxTokens" type="number" min="1" step="1" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="e.g. 800" />
            </div>

            <div>
              <label for="apiKey" class="block text-sm text-white/70 mb-1">API Key</label>
              <input id="apiKey" type="password" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="sk‑... or lm‑studio" autocomplete="off" />
              <label class="mt-2 inline-flex items-center gap-2 text-sm text-white/70 select-none">
                <input id="rememberKey" type="checkbox" class="rounded bg-black/60 border-white/20" /> Remember key locally
              </label>
            </div>

            <div class="hairline"></div>

            <div class="flex flex-wrap items-center gap-2">
              <button id="lmPresetBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
                LM Studio Preset
              </button>
              <button id="listModelsBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
                List Models
              </button>
            </div>

            <!-- Detected models: click to fill the Model field -->
            <div>
              <div class="text-sm text-white/70 mb-2">Detected models</div>
              <div id="modelsArea" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <script>
      // ------------------------------
      // Utility functions (backward‑compatible; added comments & hardening)
      // ------------------------------

      /**
       * Safely strip Markdown code fences (```lang ... ```), keeping only the code body.
       * Prevents mixing explanatory prose into the output area.
       * Supports: ```js\n...\n``` / ```\n...\n``` / no fences.
       *
       * ⚠️ Note: keep hyphen (-) at the end/beginning of the character class to avoid ranges.
       * @param {string} s - raw model text
       * @returns {string} code without surrounding fences
       */
      function stripCodeFence(s = '') {
        if (typeof s !== 'string') return '';
        const trimmed = s.trim();
        // Case A: ```lang\n...\n``` — lang can be js, ts, py, c++, c#, jsx, tsx, html, etc.
        const fenceLang = /^```[A-Za-z0-9+_.-]*\n([\s\S]*?)\n```$/m; // hyphen at the end to avoid range parsing
        const m1 = trimmed.match(fenceLang);
        if (m1) return m1[1].trim();
        // Case B: ```\n...\n```
        const fence = /^```\n([\s\S]*?)\n```$/m;
        const m2 = trimmed.match(fence);
        if (m2) return m2[1].trim();
        return trimmed;
      }

      /**
       * Derive a base "/v1" endpoint from a full Chat Completions endpoint for model probing.
       * Example: /v1/chat/completions → /v1
       */
      function baseFromEndpoint(ep = '') {
        try {
          const url = new URL(ep);
          // If path contains "/v1", trim to that point
          const i = url.pathname.indexOf('/v1');
          if (i >= 0) {
            url.pathname = url.pathname.slice(0, i + 3);
            url.search = '';
            url.hash = '';
            return url.toString().replace(/\/$/, '');
          }
          // Common mapping: /chat/completions or /completions /embeddings → /v1
          url.pathname = '/v1';
          url.search = '';
          url.hash = '';
          return url.toString().replace(/\/$/, '');
        } catch (e) {
          return ep; // let the caller validate
        }
      }

      /** Unified error display */
      function showError(msg = '') {
        const box = document.getElementById('errorBox');
        if (!msg) {
          box.classList.add('hidden');
          box.textContent = '';
        } else {
          box.textContent = msg;
          box.classList.remove('hidden');
        }
      }

      /** Toggle busy state: disable button + change label */
      function setBusy(isBusy) {
        const btn = document.getElementById('transformBtn');
        const label = document.getElementById('transformText');
        btn.disabled = !!isBusy;
        label.textContent = isBusy ? 'Transforming…' : 'Transform';
      }

      /** Progress bar update (0–100) + status text */
      function progress(pct = 0, text = '') {
        const bar = document.getElementById('progressBar');
        const t = document.getElementById('progressText');
        const v = Math.max(0, Math.min(100, pct));
        bar.style.width = v + '%';
        if (text) t.textContent = text;
      }
      function endProgress() { progress(100, 'Done'); setTimeout(() => progress(0, 'Ready'), 450); }

      /**
       * Build messages (system + user):
       * - Comment language/style/verbosity/inclusions are taken from Settings.
       * - Enforce raw-code-only output (no fences, escapes, curly quotes, or zero-width chars).
       */
      function buildMessages() {
        const input = document.getElementById('input').value;

        // --- Read user choices from Settings ---
        const langSel = document.getElementById('commentLang');
        const styleSel = document.getElementById('commentStyle');
        const verbSel  = document.getElementById('commentVerbosity');
        const includeModuleHeader = document.getElementById('includeModuleHeader')?.checked ?? true;
        const includeEdgeCases    = document.getElementById('includeEdgeCases')?.checked ?? true;
        const includeComplexity   = document.getElementById('includeComplexity')?.checked ?? false;
        const includeRationale    = document.getElementById('includeRationale')?.checked ?? true;

        const langCode = (langSel && langSel.value) || 'en';
        const style    = (styleSel && styleSel.value) || 'auto';
        const verbosity= (verbSel  && verbSel.value)  || 'standard';

        // Map UI code → human‑readable language for the prompt
        const langMap = {
          en: 'English', zh: 'Chinese (Simplified)', ja: 'Japanese', ko: 'Korean', es: 'Spanish', de: 'German', fr: 'French'
        };
        const commentLanguage = langMap[langCode] || 'English';

        // Style directive (language‑aware)
        let styleDirective = '';
        switch (style) {
          case 'jsdoc':
            styleDirective = 'Use JSDoc/TSDoc block comments (/** ... */) with @param, @returns, @throws, and @example where helpful. For TS, include types where obvious.';
            break;
          case 'google':
            styleDirective = 'Use Google‑style Python docstrings. Sections: Args, Returns, Raises, Examples (optional).';
            break;
          case 'numpy':
            styleDirective = 'Use NumPy‑style Python docstrings with Parameters/Returns/Raises/Examples sections.';
            break;
          case 'rst':
            styleDirective = 'Use reStructuredText docstrings (Sphinx) with :param:, :type:, :returns:, :raises: fields.';
            break;
          case 'doxygen':
            styleDirective = 'Use Doxygen/Javadoc‑style block comments with @param, @return, @throws, and brief descriptions.';
            break;
          default:
            styleDirective = 'Choose an idiomatic documentation style based on the detected language: JS/TS → JSDoc/TSDoc; Python → Google (or NumPy for scientific code); Java/C#/C++ → Javadoc/Doxygen; Go → leading // doc comments; Rust → /// doc comments. If unsure, use plain block comments of the language.';
        }

        // Verbosity directive
        let verbosityDirective = '';
        if (verbosity === 'minimal') {
          verbosityDirective = 'Comments should be minimal: only file header (if enabled), function/method doc comments, and very few inline notes for non‑obvious logic.';
        } else if (verbosity === 'detailed') {
          verbosityDirective = 'Comments should be detailed and rigorous: add clear function doc comments with parameter types/constraints, return value, error conditions; include non‑obvious invariants and reasoning as inline comments.';
        } else {
          verbosityDirective = 'Comments should be standard: brief function doc comments and short inline notes for tricky parts.';
        }

        // Inclusion toggles
        const includeLines = [
          includeModuleHeader ? 'Include a concise module/file header at the top (purpose, public surface, key dependencies).' : 'Do not add a module/file header.',
          includeEdgeCases ? 'Explicitly list edge cases and key assumptions in doc comments when relevant.' : 'Do not enumerate edge cases unless strictly necessary.',
          includeComplexity ? 'Add time/space complexity notes where relevant.' : 'Do not add complexity notes.',
          includeRationale ? 'Add inline rationale comments for non‑obvious decisions and trade‑offs.' : 'Avoid inline rationale comments unless essential.'
        ].join('\n'); // Use escaped newline, not literal line break, to avoid syntax errors when embedding

        // System prompt assembled from the above settings
        const system = `You are a senior software engineer who rewrites code into a modern, clean, and idiomatic style while preserving behavior.

COMMENTING POLICY (rigorous AI style):
- Write all comments in ${commentLanguage}. Use the correct syntax for the detected language.
- ${styleDirective}
- ${verbosityDirective}
- ${includeLines}

OUTPUT RULES (avoid garbled text):
- Output RAW CODE ONLY — no Markdown fences, no prose, no HTML escaping.
- Keep original non-ASCII text unchanged.
- Use straight ASCII quotes ' and ". Never use curly quotes or full-width punctuation in code.
- Do NOT emit zero-width characters (U+200B/U+200C/U+200D) or BOM (U+FEFF).
- Use LF line endings (\n).
- Keep APIs/semantics identical; prefer early returns, small functions, clear naming.`;

        const user = `<code>\n${input}\n</code>`;
        return [
          { role: 'system', content: system },
          { role: 'user', content: user },
        ];
      }

      /**
       * Normalize model output to avoid garbled text — handle BOM, zero‑width chars, NBSP, quotes, and newline forms.
       *
       * Order of operations (important):
       * 1) Strip leading BOM; 2) Remove all zero‑width chars (U+200B–U+200D and U+FEFF);
       * 3) Replace NBSP (U+00A0) with a normal space; 4) Straighten curly quotes;
       * 5) Try Unicode NFC normalization; 6) Unify newlines to LF.
       */
      function normalizeOutput(s = '') {
        // Guard: coerce to string to handle null/undefined
        let t = String(s ?? '');
        // 1) Leading BOM (only occurs at file head)
        t = t.replace(/^\uFEFF/, '');
        // 2) All zero‑width characters (ZWSP/ZWJ/ZWNJ and FEFF)
        t = t.replace(/[\u200B-\u200D\uFEFF]/g, '');
        // 3) NBSP → normal space (preserve original positions)
        t = t.replace(/\u00A0/g, ' ');
        // 4) Curly quotes → straight quotes (avoid syntax issues)
        t = t.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
        // 5) Unicode normalization (best effort)
        try { if (typeof t.normalize === 'function') t = t.normalize('NFC'); } catch {}
        // 6) Newlines → LF (CRLF / LSEP / PSEP)
        t = t.replace(/\r\n?|\u2028|\u2029/g, '\n');
        return t;
      }

      /**
       * Probe the models (GET {base}/models) and render clickable chips.
       */
      async function probeModels() {
        const endpoint = document.getElementById('endpoint').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const area = document.getElementById('modelsArea');
        area.innerHTML = '<div class="text-white/60 text-sm">Probing…</div>';

        let base = baseFromEndpoint(endpoint);
        if (!base) {
          area.innerHTML = '<div class="text-red-300 text-sm">Invalid endpoint.</div>';
          return;
        }

        try {
          const res = await fetch(base + '/models', {
            method: 'GET',
            headers: apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {},
          });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const data = await res.json();
          const ids = (data?.data || []).map(d => d.id).filter(Boolean);
          if (!ids.length) {
            area.innerHTML = '<div class="text-white/60 text-sm">No models returned.</div>';
            return;
          }
          area.innerHTML = '';
          ids.forEach(id => {
            const b = document.createElement('button');
            b.className = 'inline-flex items-center gap-1 rounded-full bg-white/10 hover:bg-white/15 px-3 py-1.5 text-xs';
            b.textContent = id;
            b.addEventListener('click', () => { document.getElementById('model').value = id; });
            area.appendChild(b);
          });
        } catch (err) {
          area.innerHTML = `<div class="text-red-300 text-sm">Probe failed: ${String(err.message || err)}</div>`;
        }
      }

      // ------------------------------
      // Core: run a single Transform
      // ------------------------------
      async function runTransform() {
        showError('');
        setBusy(true);
        progress(5, 'Validating…');

        // Read config
        const endpoint = document.getElementById('endpoint').value.trim();
        const model = document.getElementById('model').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const maxTokensRaw = document.getElementById('maxTokens').value.trim();
        const temperature = Number(document.getElementById('temperature').value || 0.2);
        const inputEl = document.getElementById('input');
        const outputEl = document.getElementById('output');

        // Basic validation
        if (!endpoint || !model) {
          showError('Endpoint & Model are required.');
          setBusy(false); endProgress(); return;
        }
        if (!inputEl.value.trim()) {
          showError('Please paste some input code.');
          setBusy(false); endProgress(); return;
        }

        progress(15, 'Preparing request…');

        // OpenAI‑compatible Chat Completions payload
        const body = {
          model,
          temperature,
          messages: buildMessages(),
          stream: false,
        };
        const maxTokens = parseInt(maxTokensRaw, 10);
        if (!Number.isNaN(maxTokens) && maxTokens > 0) body.max_tokens = maxTokens;

        const headers = { 'Content-Type': 'application/json' };
        if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

        try {
          progress(35, 'Calling model…');
          const res = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
          progress(55, 'Reading…');

          // Error handling: try to provide helpful hints (CORS/path/auth)
          if (!res.ok) {
            const text = await res.text().catch(() => '');
            showError(`Request failed: ${res.status} ${res.statusText}.\n\nResponse: ${text || '(no body)'}\n\nHints: check CORS, endpoint path, model id, API key/port.`);
            setBusy(false); endProgress(); return;
          }

          const data = await res.json();
          progress(75, 'Parsing…');

          // Support choices[0].message.content or choices[0].text
          const raw = data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.text ?? '';
          const code = stripCodeFence(String(raw || ''));

          outputEl.value = normalizeOutput(code);
          // Subtle "updated" feedback
          outputEl.classList.add('ring-2', 'ring-white/30');
          setTimeout(() => outputEl.classList.remove('ring-2', 'ring-white/30'), 480);

          endProgress();
        } catch (err) {
          showError(`Network/parse error: ${String(err.message || err)}`);
          endProgress();
        } finally {
          setBusy(false);
        }
      }

      // ------------------------------
      // Dev self-tests: verify regex & normalization logic
      // ------------------------------
      function runSelfTests() {
        /** tiny assertion helper */
        const eq = (a, b) => a === b;
        const results = [];
        const push = (name, ok, detail = '') => results.push({ name, ok, detail });

        // stripCodeFence cases
        try {
          push('fenceLang js', eq(stripCodeFence("```js\nconsole.log('x');\n```"), "console.log('x');"));
          push('fenceLang c++', eq(stripCodeFence("```c++\nint x=0;\n```"), "int x=0;"));
          push('fenceLang tsx', eq(stripCodeFence("```tsx\nconst A=()=>null;\n```"), "const A=()=>null;"));
          push('fence plain', eq(stripCodeFence("```\na\nb\n```"), "a\nb"));
          push('no fence', eq(stripCodeFence("foo"), "foo"));
        } catch (e) { push('stripCodeFence exception', false, String(e)); }

        // normalizeOutput core cases
        try {
          // NBSP is between the second 'a' and 'b'; it should remain a normal space after replacement
          push('BOM + ZW + NBSP', eq(normalizeOutput("\uFEFFa\u200Ba\u00A0b\u200Da"), "aa ba"));
          // Variant: NBSP after 'b'
          push('NBSP after b', eq(normalizeOutput("\uFEFFa\u200Bb\u00A0\u200Da"), "ab a"));
          // Multiple NBSP: each replaced by a normal space (no collapsing)
          push('multiple NBSP', eq(normalizeOutput("a\u00A0\u00A0b"), "a  b"));
          // Quote straightening
          push('quotes straightened', eq(normalizeOutput("“a” ‘b’"), '"a" \'' + 'b\''));
          // Newline unification
          push('newlines unified', eq(normalizeOutput("a\r\nb\u2028c\u2029d"), "a\nb\nc\nd"));
          // ZWJ/ZWNJ removal
          push('ZWJ/ZWNJ', eq(normalizeOutput("a\u200Ca\u200Da"), "aaa"));
          // No-change path
          push('no change', eq(normalizeOutput("hello"), "hello"));
        } catch (e) { push('normalizeOutput exception', false, String(e)); }

        // Ensure we join using literal \n (not actual newlines)
        try { push('join\\n', eq(['a','b'].join('\n'), 'a\nb')); } catch (e) { push('join\\n exception', false, String(e)); }

        // Report
        const pass = results.filter(r => r.ok).length;
        const total = results.length;
        console.group('[AI-style Code Rewriter] Self-tests');
        results.forEach(r => console[r.ok ? 'log' : 'error'](`${r.ok ? '✅' : '❌'} ${r.name}${r.detail ? ' — ' + r.detail : ''}`));
        console.log(`Passed ${pass}/${total}`);
        console.groupEnd();

        const box = document.getElementById('devTests');
        if (box) {
          box.textContent = `Self-tests: ${pass}/${total} passed`;
          box.className = `mt-2 text-xs ${pass === total ? 'text-green-300' : 'text-yellow-300'}`;
        }
      }

      // ------------------------------
      // Init: event bindings, example, persistence
      // ------------------------------
      function init() {
        const $ = (id) => document.getElementById(id);

        // Default example snippet for demo
        $('input').value = `function fetchUsers(cb){fetch('/api/users').then(r=>r.json()).then(d=>{let arr=[];for(let i=0;i<d.length;i++){if(d[i]&&d[i].active){arr.push({id:d[i].id,name:d[i].name.trim()})}}cb&&cb(arr)}).catch(e=>{console.log(e)})}`;

        // Temperature slider → live number
        const temp = $('temperature');
        const tempVal = $('tempVal');
        const syncTemp = () => (tempVal.textContent = String(Number(temp.value).toFixed(1)));
        temp.addEventListener('input', syncTemp); syncTemp();

        // Copy & clear
        $('copyBtn').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText($('output').value || '');
            $('copyBtn').classList.add('animate-pulseSoft');
            setTimeout(() => $('copyBtn').classList.remove('animate-pulseSoft'), 600);
          } catch {}
        });
        $('clearBtn').addEventListener('click', () => { $('output').value = ''; });

        // Settings drawer open/close
        const panel = $('settingsPanel');
        const aside = panel.querySelector('aside');
        const openSettings = () => { panel.classList.remove('hidden'); requestAnimationFrame(() => { aside.style.transform = 'translateX(0)'; }); };
        const closeSettings = () => { aside.style.transform = 'translateX(100%)'; setTimeout(() => panel.classList.add('hidden'), 240); };
        $('openSettingsBtn').addEventListener('click', openSettings);
        $('closeSettingsBtn').addEventListener('click', closeSettings);
        $('backdrop').addEventListener('click', closeSettings);

        // Remember API key locally (optional)
        const KEY = 'ai_style_api_key';
        const remember = $('rememberKey');
        const apiKey = $('apiKey');
        // Restore
        try {
          const saved = localStorage.getItem(KEY);
          if (saved) { apiKey.value = saved; remember.checked = true; }
        } catch {}
        // Persist on change
        const syncKey = () => {
          try {
            if (remember.checked && apiKey.value) localStorage.setItem(KEY, apiKey.value);
            else localStorage.removeItem(KEY);
          } catch {}
        };
        remember.addEventListener('change', syncKey);
        apiKey.addEventListener('input', syncKey);

        // LM Studio quick preset
        $('lmPresetBtn').addEventListener('click', () => {
          $('endpoint').value = 'http://localhost:1234/v1/chat/completions';
          if (!apiKey.value) apiKey.value = 'lm-studio';
        });

        // List models
        $('listModelsBtn').addEventListener('click', () => probeModels());

        // Trigger transform
        $('transformBtn').addEventListener('click', () => runTransform());
        // Shortcut: Cmd/Ctrl + Enter
        window.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            e.preventDefault();
            runTransform();
          }
        });

        // Initial state
        progress(0, 'Ready');

        // Run self-tests
        runSelfTests();
      }

      // Boot
      window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Dev self-test results (visually hidden) -->
    <div id="devTests" class="sr-only" aria-hidden="true"></div>
  </body>
</html>
