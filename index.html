<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI‑style Code Rewriter • Apple‑inspired</title>

    <!--
      设计说明（Apple 风格要点）
      ---------------------------------------------------------------------
      • Typography: 使用 -apple-system（San Francisco）级联，字重与字距较为内敛。
      • Layout: 大标题 + 卡片式内容区，充足留白；控件对齐，层级清晰。
      • Visuals: 暗色基底 + 半透明毛玻璃（backdrop-blur），发光投影适度；细线分割（hairline）。
      • Motion: 微弱的过渡与缩放反馈，尊重 prefers-reduced-motion。
      • Clarity: 更少视觉干扰，明确的主按钮（Transform）。
      • Accessibility: 明确的 aria-label / role，良好的对比度与键盘交互（Cmd/Ctrl+Enter 触发转化）。
    -->

    <!-- Tailwind 配置要在 CDN 之前声明 -->
    <script>
      /*
        Tailwind on CDN: 通过全局 tailwind.config 定制字体与阴影等。
        这里增加 iOS 风格常用的阴影、圆角、以及字体族。
      */
      window.tailwind = window.tailwind || {};
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: [
                '-apple-system',
                'BlinkMacSystemFont',
                'Segoe UI',
                'Roboto',
                'Noto Sans',
                'Helvetica Neue',
                'Arial',
                'sans-serif',
              ],
            },
            boxShadow: {
              ios: '0 10px 30px rgba(0,0,0,0.35), 0 1px 0 rgba(255,255,255,0.06) inset',
            },
            colors: {
              // 更贴近 Apple 暗色体系的中性色（自定义，仅作接近处理）
              surface: {
                50: 'rgba(255,255,255,0.04)',
                100: 'rgba(255,255,255,0.06)',
              },
            },
            transitionTimingFunction: {
              ios: 'cubic-bezier(0.22, 0.61, 0.36, 1)', // iOS 弹性惯性感
            },
            keyframes: {
              pulseSoft: {
                '0%, 100%': { transform: 'scale(1)', opacity: 1 },
                '50%': { transform: 'scale(0.985)', opacity: 0.9 },
              },
            },
            animation: {
              pulseSoft: 'pulseSoft 1.8s ease-in-out infinite',
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /*
        额外的低层样式：
        - 毛玻璃卡片（.glass）
        - 极细分割线（.hairline）
      */
      .glass { backdrop-filter: saturate(160%) blur(20px); -webkit-backdrop-filter: saturate(160%) blur(20px); }
      .hairline { border-top: 1px solid rgba(255,255,255,0.06); }

      /* 减少动画偏好：关闭非必要动效 */
      @media (prefers-reduced-motion: reduce) {
        .animate-pulseSoft { animation: none !important; }
        * { transition: none !important; }
      }

      /* 聚焦可见性（辅助可及性） */
      :focus-visible { outline: 2px solid rgba(255,255,255,0.6); outline-offset: 2px; border-radius: 12px; }

      /* 代码区更友好的等宽字体 */
      textarea, code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

      /* Apple‑style accent button (luminous gradient) */
      .accent-btn { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%); color: #fff; box-shadow: 0 10px 30px rgba(168,85,247,0.25); }
      .accent-btn:hover { filter: brightness(1.05); }
      .accent-btn:disabled { opacity: .6; cursor: not-allowed; }

      /* Colorful progress bar with gentle sweep */
      .progress-track { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.08); }
      .progress-bar { background: linear-gradient(90deg, #34d399, #22d3ee, #60a5fa, #a78bfa, #f472b6); background-size: 300% 100%; animation: gradientShift 4s ease infinite; transition: width .4s cubic-bezier(0.22, 0.61, 0.36, 1), background-position 2.4s linear; }
      @keyframes gradientShift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
    </style>
  </head>

  <body class="min-h-screen bg-black text-white font-sans selection:bg-white/10">
    <!--
      顶部导航 —— 大标题 + 右侧工具（设置按钮）
      - 视觉层级：标题 > 操作控件
      - 对齐：内容宽度限制在 1200px，保证舒适阅读宽度
    -->
    <header class="sticky top-0 z-40 bg-black/60 glass backdrop-saturate-150 border-b border-white/10">
      <div class="mx-auto max-w-6xl px-4">
        <div class="flex items-center justify-between h-16">
          <h1 class="text-xl sm:text-2xl tracking-tight font-semibold">
            AI‑style Code Rewriter
          </h1>
          <div class="flex items-center gap-2">
            <button id="openSettingsBtn" class="group inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5" aria-label="Open settings">
              <!-- Simplified, crisper Settings icon (sliders) for better legibility -->
              <svg class="w-4 h-4 opacity-90 group-hover:opacity-100 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                <line x1="4" y1="6" x2="20" y2="6"/>
                <line x1="4" y1="12" x2="20" y2="12"/>
                <line x1="4" y1="18" x2="20" y2="18"/>
                <circle cx="9" cy="6" r="2"/>
                <circle cx="15" cy="12" r="2"/>
                <circle cx="7" cy="18" r="2"/>
              </svg>
              <span class="text-sm">Settings</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 主体区域：左右两栏 —— 输入与输出 -->
    <main class="mx-auto max-w-6xl px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 输入卡片 -->
        <section class="relative rounded-2xl bg-surface-50/50 border border-white/10 glass shadow-ios">
          <div class="p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-medium opacity-90">Input</h2>
              <div class="text-xs text-white/60">Paste code to restyle</div>
            </div>
            <textarea id="input" class="w-full h-[360px] lg:h-[520px] p-3 sm:p-4 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/30 resize-y" spellcheck="false" aria-label="Input code"></textarea>
          </div>
        </section>

        <!-- 输出卡片 -->
        <section class="relative rounded-2xl bg-surface-50/50 border border-white/10 glass shadow-ios">
          <div class="p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-base font-medium opacity-90">Output</h2>
              <div class="flex items-center gap-2">
                <button id="copyBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm" aria-label="Copy output">
                  <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  Copy
                </button>
                <button id="clearBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm" aria-label="Clear output">
                  <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  Clear
                </button>
              </div>
            </div>
            <textarea id="output" class="w-full h-[360px] lg:h-[520px] p-3 sm:p-4 rounded-xl bg-black/40 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/30 resize-y" spellcheck="false" aria-label="Output code" readonly></textarea>
          </div>
        </section>
      </div>

      <!-- 操作区：Transform + 进度条 + 状态提示 -->
      <div class="mt-6 flex flex-col gap-3">
        <!-- 错误提示（默认隐藏） -->
        <div id="errorBox" class="hidden rounded-xl border border-red-500/30 bg-red-400/10 text-red-200 px-4 py-3"></div>

        <div class="flex items-center gap-2">
          <button id="transformBtn" class="inline-flex items-center justify-center rounded-full accent-btn active:scale-[0.98] transition-transform ease-ios px-5 py-3 text-sm font-medium shadow-ios">
            <span id="transformText">Transform</span>
          </button>

          <!-- 进度条（纤细） -->
          <div class="flex-1 basis-[65%] h-2 rounded-full overflow-hidden progress-track">
            <div id="progressBar" class="h-full w-0 rounded-full progress-bar"></div>
          </div>
          <div id="progressText" class="text-xs text-white/70 w-[110px] text-right">Ready</div>
        </div>

        <p class="text-xs text-white/50">Tip: Press <kbd class="px-1.5 py-0.5 bg-white/10 rounded border border-white/15">⌘/Ctrl</kbd> + <kbd class="px-1.5 py-0.5 bg-white/10 rounded border border-white/15">Enter</kbd> to Transform</p>
      </div>
    </main>

    <!-- 设置抽屉（右侧滑出） -->
    <div id="settingsPanel" class="fixed inset-0 z-50 hidden" aria-hidden="true">
      <!-- 半透明蒙层 -->
      <div id="backdrop" class="absolute inset-0 bg-black/50 transition-opacity"></div>

      <!-- 抽屉面板 -->
      <aside class="absolute right-0 top-0 h-full w-full sm:w-[460px] bg-black/80 glass backdrop-saturate-150 border-l border-white/10 shadow-2xl transform translate-x-full transition-transform ease-ios" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="h-full flex flex-col">
          <div class="flex items-center justify-between p-4 sm:p-5 border-b border-white/10">
            <h3 class="text-lg font-semibold">Settings</h3>
            <button id="closeSettingsBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
              Close
            </button>
          </div>

          <div class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-5">
            <!--
              连接参数区域：更贴近 Apple 的表单风格
              - 标签与控件垂直堆叠，控件使用圆角与毛玻璃背景
            -->
            <div>
              <label for="endpoint" class="block text-sm text-white/70 mb-1">Endpoint</label>
              <input id="endpoint" type="text" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="https://api.openai.com/v1/chat/completions" />
              <p class="mt-1 text-xs text-white/50">OpenAI‑compatible Chat Completions endpoint.</p>
            </div>

            <div>
              <label for="model" class="block text-sm text-white/70 mb-1">Model</label>
              <input id="model" type="text" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="gpt-4o-mini / llama‑3.1‑8b‑instruct / qwen2.5‑7b‑instruct" />
            </div>

            <!-- 注释语言（影响 AI 生成代码中的注释语言） -->
            <div>
              <label for="commentLang" class="block text-sm text-white/70 mb-1">Comment language</label>
              <select id="commentLang" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="en" selected>English</option>
                <option value="zh">中文（简体）</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <option value="es">Español</option>
                <option value="de">Deutsch</option>
                <option value="fr">Français</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Controls the language of comments the AI adds to your code.</p>
            </div>

            <!-- 注释风格（JSDoc / Google / NumPy / reST / Doxygen / Auto） -->
            <div>
              <label for="commentStyle" class="block text-sm text-white/70 mb-1">Comment style</label>
              <select id="commentStyle" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="auto" selected>Auto (language‑aware)</option>
                <option value="jsdoc">JSDoc / TSDoc</option>
                <option value="google">Google (Python)</option>
                <option value="numpy">NumPy (Python)</option>
                <option value="rst">reStructuredText (Python)</option>
                <option value="doxygen">Doxygen / Javadoc (C/C++/Java/C#)</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Pick a doc style. Auto chooses based on the detected language.</p>
            </div>

            <!-- 注释详尽程度（Minimal / Standard / Detailed） -->
            <div>
              <label for="commentVerbosity" class="block text-sm text-white/70 mb-1">Comment detail level</label>
              <select id="commentVerbosity" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2">
                <option value="minimal">Minimal</option>
                <option value="standard" selected>Standard</option>
                <option value="detailed">Detailed</option>
              </select>
              <p class="mt-1 text-xs text-white/50">Controls how deep the AI goes with docs and inline notes.</p>
            </div>

            <!-- 注释内容包含项 -->
            <div>
              <label class="block text-sm text-white/70 mb-1">Include in comments</label>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeModuleHeader" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Module/file header
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeEdgeCases" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Edge cases & assumptions
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeComplexity" type="checkbox" class="rounded bg-black/60 border-white/20" /> Time/space complexity
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-white/80 select-none">
                  <input id="includeRationale" type="checkbox" class="rounded bg-black/60 border-white/20" checked /> Inline rationale (non‑obvious logic)
                </label>
              </div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-1">
                <label for="temperature" class="text-sm text-white/70">Strength <span class="text-white/40">(强度)</span></label>
                <span id="tempVal" class="text-sm text-white/80">0.2</span>
              </div>
              <!-- iOS 风格滑块：圆形拇指 + 细轨道（使用原生 range + Tailwind 样式覆盖） -->
              <input id="temperature" type="range" min="0" max="2" step="0.1" value="0.2" class="w-full h-2 bg-white/10 rounded-full appearance-none" />
              <p class="mt-1 text-xs text-white/50">Higher → bolder rewrites; lower → conservative.</p>
            </div>

            <div>
              <label for="maxTokens" class="block text-sm text-white/70 mb-1">Max tokens (optional)</label>
              <input id="maxTokens" type="number" min="1" step="1" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="e.g. 800" />
            </div>

            <div>
              <label for="apiKey" class="block text-sm text-white/70 mb-1">API Key</label>
              <input id="apiKey" type="password" class="w-full rounded-xl bg-black/40 border border-white/15 focus:ring-2 focus:ring-white/30 px-3 py-2" placeholder="sk‑... or lm‑studio" autocomplete="off" />
              <label class="mt-2 inline-flex items-center gap-2 text-sm text-white/70 select-none">
                <input id="rememberKey" type="checkbox" class="rounded bg-black/60 border-white/20" /> Remember key locally
              </label>
            </div>

            <div class="hairline"></div>

            <div class="flex flex-wrap items-center gap-2">
              <button id="lmPresetBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
                LM Studio Preset
              </button>
              <button id="listModelsBtn" class="inline-flex items-center gap-2 rounded-full bg-white/10 hover:bg-white/15 active:scale-[0.98] transition-transform ease-ios px-3 py-1.5 text-sm">
                List Models
              </button>
            </div>

            <!-- 模型探测结果：点击填充到 Model -->
            <div>
              <div class="text-sm text-white/70 mb-2">Detected models</div>
              <div id="modelsArea" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <script>
      // ------------------------------
      // 工具函数（与原版兼容，但增加了注释与健壮性）
      // ------------------------------

      /**
       * 安全剥离模型可能返回的 Markdown 围栏代码块（```lang ... ```）
       * 仅保留代码体，避免把解释性文字混入输出。
       * 兼容：```js\n...\n``` / ```\n...\n``` / 无围栏
       *
       * ⚠️ 细节：字符类中的连字符（-）要放在末尾或开头，避免被解析为范围。
       * @param {string} s - 原始模型返回文本
       * @returns {string} 去除围栏后的代码
       */
      function stripCodeFence(s = '') {
        if (typeof s !== 'string') return '';
        const trimmed = s.trim();
        // 情况 A：```lang\n...\n``` —— lang 可为 js, ts, py, c++, c#, jsx, tsx, html 等
        const fenceLang = /^```[A-Za-z0-9+_.-]*\n([\s\S]*?)\n```$/m; // 连字符放末尾，避免范围错误
        const m1 = trimmed.match(fenceLang);
        if (m1) return m1[1].trim();
        // 情况 B：```\n...\n```
        const fence = /^```\n([\s\S]*?)\n```$/m;
        const m2 = trimmed.match(fence);
        if (m2) return m2[1].trim();
        return trimmed;
      }

      /**
       * 从用户填写的 endpoint 推断出 “/v1” 基地址，用于探测 models。
       * 例：输入 /v1/chat/completions → 基址 /v1
       */
      function baseFromEndpoint(ep = '') {
        try {
          const url = new URL(ep);
          // 若路径中包含 "/v1"，裁剪到 v1 为止
          const i = url.pathname.indexOf('/v1');
          if (i >= 0) {
            url.pathname = url.pathname.slice(0, i + 3);
            url.search = '';
            url.hash = '';
            return url.toString().replace(/\/$/, '');
          }
          // 常见映射：/chat/completions 或 /completions /embeddings → /v1
          url.pathname = '/v1';
          url.search = '';
          url.hash = '';
          return url.toString().replace(/\/$/, '');
        } catch (e) {
          return ep; // 交给上层校验
        }
      }

      /** 统一的错误展示 */
      function showError(msg = '') {
        const box = document.getElementById('errorBox');
        if (!msg) {
          box.classList.add('hidden');
          box.textContent = '';
        } else {
          box.textContent = msg;
          box.classList.remove('hidden');
        }
      }

      /** 切换忙碌态：禁用按钮 + 文案 */
      function setBusy(isBusy) {
        const btn = document.getElementById('transformBtn');
        const label = document.getElementById('transformText');
        btn.disabled = !!isBusy;
        label.textContent = isBusy ? 'Transforming…' : 'Transform';
      }

      /** 进度条更新（0–100）+ 状态文本 */
      function progress(pct = 0, text = '') {
        const bar = document.getElementById('progressBar');
        const t = document.getElementById('progressText');
        const v = Math.max(0, Math.min(100, pct));
        bar.style.width = v + '%';
        if (text) t.textContent = text;
      }
      function endProgress() { progress(100, 'Done'); setTimeout(() => progress(0, 'Ready'), 450); }

      /**
       * 构造消息（system + user）。
       * - 注释语言由设置项决定（English / Chinese (Simplified)）。
       * - 强制输出“只有代码，无围栏/无转义/无弯引号/无零宽字符”。
       */
      function buildMessages() {
        const input = document.getElementById('input').value;

        // --- Read user choices from Settings ---
        const langSel = document.getElementById('commentLang');
        const styleSel = document.getElementById('commentStyle');
        const verbSel  = document.getElementById('commentVerbosity');
        const includeModuleHeader = document.getElementById('includeModuleHeader')?.checked ?? true;
        const includeEdgeCases    = document.getElementById('includeEdgeCases')?.checked ?? true;
        const includeComplexity   = document.getElementById('includeComplexity')?.checked ?? false;
        const includeRationale    = document.getElementById('includeRationale')?.checked ?? true;

        const langCode = (langSel && langSel.value) || 'en';
        const style    = (styleSel && styleSel.value) || 'auto';
        const verbosity= (verbSel  && verbSel.value)  || 'standard';

        // Map UI code → human‑readable language for the prompt
        const langMap = {
          en: 'English', zh: 'Chinese (Simplified)', ja: 'Japanese', ko: 'Korean', es: 'Spanish', de: 'German', fr: 'French'
        };
        const commentLanguage = langMap[langCode] || 'English';

        // Style directive (language‑aware)
        let styleDirective = '';
        switch (style) {
          case 'jsdoc':
            styleDirective = 'Use JSDoc/TSDoc block comments (/** ... */) with @param, @returns, @throws, and @example where helpful. For TS, include types where obvious.';
            break;
          case 'google':
            styleDirective = 'Use Google‑style Python docstrings. Sections: Args, Returns, Raises, Examples (optional).';
            break;
          case 'numpy':
            styleDirective = 'Use NumPy‑style Python docstrings with Parameters/Returns/Raises/Examples sections.';
            break;
          case 'rst':
            styleDirective = 'Use reStructuredText docstrings (Sphinx) with :param:, :type:, :returns:, :raises: fields.';
            break;
          case 'doxygen':
            styleDirective = 'Use Doxygen/Javadoc‑style block comments with @param, @return, @throws, and brief descriptions.';
            break;
          default:
            styleDirective = 'Choose an idiomatic documentation style based on the detected language: JS/TS → JSDoc/TSDoc; Python → Google (or NumPy for scientific code); Java/C#/C++ → Javadoc/Doxygen; Go → leading // doc comments; Rust → /// doc comments. If unsure, use plain block comments of the language.';
        }

        // Verbosity directive
        let verbosityDirective = '';
        if (verbosity === 'minimal') {
          verbosityDirective = 'Comments should be minimal: only file header (if enabled), function/method doc comments, and very few inline notes for non‑obvious logic.';
        } else if (verbosity === 'detailed') {
          verbosityDirective = 'Comments should be detailed and rigorous: add clear function doc comments with parameter types/constraints, return value, error conditions; include non‑obvious invariants and reasoning as inline comments.';
        } else {
          verbosityDirective = 'Comments should be standard: brief function doc comments and short inline notes for tricky parts.';
        }

        // Inclusion toggles
        const includeLines = [
          includeModuleHeader ? 'Include a concise module/file header at the top (purpose, public surface, key dependencies).' : 'Do not add a module/file header.',
          includeEdgeCases ? 'Explicitly list edge cases and key assumptions in doc comments when relevant.' : 'Do not enumerate edge cases unless strictly necessary.',
          includeComplexity ? 'Add time/space complexity notes where relevant.' : 'Do not add complexity notes.',
          includeRationale ? 'Add inline rationale comments for non‑obvious decisions and trade‑offs.' : 'Avoid inline rationale comments unless essential.'
        ].join('
');

        // System prompt assembled from the above settings
        const system = `You are a senior software engineer who rewrites code into a modern, clean, and idiomatic style while preserving behavior.

COMMENTING POLICY (rigorous AI style):
- Write all comments in ${commentLanguage}. Use the correct syntax for the detected language.
- ${styleDirective}
- ${verbosityDirective}
- ${includeLines}

OUTPUT RULES (avoid garbled text):
- Output RAW CODE ONLY — no Markdown fences, no prose, no HTML escaping.
- Keep original non-ASCII text unchanged.
- Use straight ASCII quotes ' and ". Never use curly quotes or full-width punctuation in code.
- Do NOT emit zero-width characters (U+200B/U+200C/U+200D) or BOM (U+FEFF).
- Use LF line endings (\n).
- Keep APIs/semantics identical; prefer early returns, small functions, clear naming.`;

        const user = `<code>
${input}
</code>`;
        return [
          { role: 'system', content: system },
          { role: 'user', content: user },
        ];
      }

      /**
       * 统一清洗输出，避免“乱码”——应对 BOM、零宽字符、NBSP 等：
       *
       * 处理步骤（顺序重要）：
       * 1) 去除开头 BOM；2) 去除所有零宽字符范围（U+200B–U+200D 与 U+FEFF）；
       * 3) NBSP(U+00A0)→普通空格；4) 替换弯引号为直引号；
       * 5) 尝试 Unicode NFC 规范化；6) 统一换行为 LF。
       */
      function normalizeOutput(s = '') {
        // 把所有输入先转为字符串，防御 null/undefined
        let t = String(s ?? '');
        // 1) 开头 BOM（仅文件头会出现）
        t = t.replace(/^\uFEFF/, '');
        // 2) 所有零宽字符（包括 ZWSP/ZWJ/ZWNJ 与 FEFF）
        t = t.replace(/[\u200B-\u200D\uFEFF]/g, '');
        // 3) NBSP → 空格（保留原本的“位置”，不调整顺序）
        t = t.replace(/\u00A0/g, ' ');
        // 4) 弯引号 → 直引号（避免代码中的花体引号造成语法错误）
        t = t.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
        // 5) Unicode 规范化（有些平台不支持，故包裹 try/catch）
        try { if (typeof t.normalize === 'function') t = t.normalize('NFC'); } catch {}
        // 6) 统一换行（CRLF / LSEP / PSEP → LF）
        t = t.replace(/\r\n?|\u2028|\u2029/g, '\n');
        return t;
      }

      /**
       * 探测模型列表（GET {base}/models）并渲染为可点击的 Chips。
       */
      async function probeModels() {
        const endpoint = document.getElementById('endpoint').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const area = document.getElementById('modelsArea');
        area.innerHTML = '<div class="text-white/60 text-sm">Probing…</div>';

        let base = baseFromEndpoint(endpoint);
        if (!base) {
          area.innerHTML = '<div class="text-red-300 text-sm">Invalid endpoint.</div>';
          return;
        }

        try {
          const res = await fetch(base + '/models', {
            method: 'GET',
            headers: apiKey ? { 'Authorization': `Bearer ${apiKey}` } : {},
          });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const data = await res.json();
          const ids = (data?.data || []).map(d => d.id).filter(Boolean);
          if (!ids.length) {
            area.innerHTML = '<div class="text-white/60 text-sm">No models returned.</div>';
            return;
          }
          area.innerHTML = '';
          ids.forEach(id => {
            const b = document.createElement('button');
            b.className = 'inline-flex items-center gap-1 rounded-full bg-white/10 hover:bg-white/15 px-3 py-1.5 text-xs';
            b.textContent = id;
            b.addEventListener('click', () => { document.getElementById('model').value = id; });
            area.appendChild(b);
          });
        } catch (err) {
          area.innerHTML = `<div class="text-red-300 text-sm">Probe failed: ${String(err.message || err)}</div>`;
        }
      }

      // ------------------------------
      // 核心：执行一次“Transform”
      // ------------------------------
      async function runTransform() {
        showError('');
        setBusy(true);
        progress(5, 'Validating…');

        // 读取配置
        const endpoint = document.getElementById('endpoint').value.trim();
        const model = document.getElementById('model').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const maxTokensRaw = document.getElementById('maxTokens').value.trim();
        const temperature = Number(document.getElementById('temperature').value || 0.2);
        const inputEl = document.getElementById('input');
        const outputEl = document.getElementById('output');

        // 基本校验
        if (!endpoint || !model) {
          showError('Endpoint & Model are required.');
          setBusy(false); endProgress(); return;
        }
        if (!inputEl.value.trim()) {
          showError('Please paste some input code.');
          setBusy(false); endProgress(); return;
        }

        progress(15, 'Preparing request…');

        // 组装请求体（OpenAI 兼容 Chat Completions）
        const body = {
          model,
          temperature,
          messages: buildMessages(),
          stream: false,
        };
        const maxTokens = parseInt(maxTokensRaw, 10);
        if (!Number.isNaN(maxTokens) && maxTokens > 0) body.max_tokens = maxTokens;

        const headers = { 'Content-Type': 'application/json' };
        if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

        try {
          progress(35, 'Calling model…');
          const res = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
          progress(55, 'Reading…');

          // 错误处理：尽量给出有用的 CORS/路径/鉴权提示
          if (!res.ok) {
            const text = await res.text().catch(() => '');
            showError(`Request failed: ${res.status} ${res.statusText}.\n\nResponse: ${text || '(no body)'}\n\nHints: check CORS, endpoint path, model id, API key/port.`);
            setBusy(false); endProgress(); return;
          }

          const data = await res.json();
          progress(75, 'Parsing…');

          // 兼容 choices[0].message.content 或 choices[0].text
          const raw = data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.text ?? '';
          const code = stripCodeFence(String(raw || ''));

          outputEl.value = normalizeOutput(code);
          // 轻微的“已更新”视觉反馈
          outputEl.classList.add('ring-2', 'ring-white/30');
          setTimeout(() => outputEl.classList.remove('ring-2', 'ring-white/30'), 480);

          endProgress();
        } catch (err) {
          showError(`Network/parse error: ${String(err.message || err)}`);
          endProgress();
        } finally {
          setBusy(false);
        }
      }

      // ------------------------------
      // 简易自测（Dev tests）：验证正则与清洗逻辑
      // ------------------------------
      function runSelfTests() {
        /** 简单断言工具 */
        const eq = (a, b) => a === b;
        const results = [];
        const push = (name, ok, detail = '') => results.push({ name, ok, detail });

        // stripCodeFence cases
        try {
          push('fenceLang js', eq(stripCodeFence("```js\nconsole.log('x');\n```"), "console.log('x');"));
          push('fence plain', eq(stripCodeFence("```\na\nb\n```"), "a\nb"));
          push('no fence', eq(stripCodeFence("foo"), "foo"));
        } catch (e) { push('stripCodeFence exception', false, String(e)); }

        // normalizeOutput core cases
        try {
          // 修正：NBSP 在原串中位于第二个 a 与 b 之间，因此替换后应保留在该位置
          push('BOM + ZW + NBSP', eq(normalizeOutput("\uFEFFa\u200Ba\u00A0b\u200Da"), "aa ba"));
          // 变体：NBSP 位于 b 之后
          push('NBSP after b', eq(normalizeOutput("\uFEFFa\u200Bb\u00A0\u200Da"), "ab a"));
          // 多个 NBSP：应一一替换为普通空格（不折叠）
          push('multiple NBSP', eq(normalizeOutput("a\u00A0\u00A0b"), "a  b"));
          // 引号矫正
          push('quotes straightened', eq(normalizeOutput("“a” ‘b’"), '"a" \'' + 'b\''));
          // 换行统一
          push('newlines unified', eq(normalizeOutput("a\r\nb\u2028c\u2029d"), "a\nb\nc\nd"));
          // 无变化路径
          push('no change', eq(normalizeOutput("hello"), "hello"));
        } catch (e) { push('normalizeOutput exception', false, String(e)); }

        // 展示结果到控制台 & 页面
        const pass = results.filter(r => r.ok).length;
        const total = results.length;
        console.group('[AI-style Code Rewriter] Self-tests');
        results.forEach(r => console[r.ok ? 'log' : 'error'](`${r.ok ? '✅' : '❌'} ${r.name}${r.detail ? ' — ' + r.detail : ''}`));
        console.log(`Passed ${pass}/${total}`);
        console.groupEnd();

        const box = document.getElementById('devTests');
        if (box) {
          box.textContent = `Self-tests: ${pass}/${total} passed`;
          box.className = `mt-2 text-xs ${pass === total ? 'text-green-300' : 'text-yellow-300'}`;
        }
      }

      // ------------------------------
      // 初始化：事件绑定、示例、持久化
      // ------------------------------
      function init() {
        const $ = (id) => document.getElementById(id);

        // 默认示例：一段“凌乱代码”，用于演示转换
        $('input').value = `function fetchUsers(cb){fetch('/api/users').then(r=>r.json()).then(d=>{let arr=[];for(let i=0;i<d.length;i++){if(d[i]&&d[i].active){arr.push({id:d[i].id,name:d[i].name.trim()})}}cb&&cb(arr)}).catch(e=>{console.log(e)})}`;

        // 温度滑块联动数值
        const temp = $('temperature');
        const tempVal = $('tempVal');
        const syncTemp = () => (tempVal.textContent = String(Number(temp.value).toFixed(1)));
        temp.addEventListener('input', syncTemp); syncTemp();

        // 复制 & 清空输出
        $('copyBtn').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText($('output').value || '');
            $('copyBtn').classList.add('animate-pulseSoft');
            setTimeout(() => $('copyBtn').classList.remove('animate-pulseSoft'), 600);
          } catch {}
        });
        $('clearBtn').addEventListener('click', () => { $('output').value = ''; });

        // 打开/关闭设置抽屉
        const panel = $('settingsPanel');
        const aside = panel.querySelector('aside');
        const openSettings = () => { panel.classList.remove('hidden'); requestAnimationFrame(() => { aside.style.transform = 'translateX(0)'; }); };
        const closeSettings = () => { aside.style.transform = 'translateX(100%)'; setTimeout(() => panel.classList.add('hidden'), 240); };
        $('openSettingsBtn').addEventListener('click', openSettings);
        $('closeSettingsBtn').addEventListener('click', closeSettings);
        $('backdrop').addEventListener('click', closeSettings);

        // 记住 API Key（可选）
        const KEY = 'ai_style_api_key';
        const remember = $('rememberKey');
        const apiKey = $('apiKey');
        // 恢复
        try {
          const saved = localStorage.getItem(KEY);
          if (saved) { apiKey.value = saved; remember.checked = true; }
        } catch {}
        // 监听变更
        const syncKey = () => {
          try {
            if (remember.checked && apiKey.value) localStorage.setItem(KEY, apiKey.value);
            else localStorage.removeItem(KEY);
          } catch {}
        };
        remember.addEventListener('change', syncKey);
        apiKey.addEventListener('input', syncKey);

        // LM Studio 一键预设
        $('lmPresetBtn').addEventListener('click', () => {
          $('endpoint').value = 'http://localhost:1234/v1/chat/completions';
          if (!apiKey.value) apiKey.value = 'lm-studio';
        });

        // 列出模型
        $('listModelsBtn').addEventListener('click', () => probeModels());

        // 触发转换
        $('transformBtn').addEventListener('click', () => runTransform());
        // 快捷键：Cmd/Ctrl + Enter
        window.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
            e.preventDefault();
            runTransform();
          }
        });

        // 初始状态
        progress(0, 'Ready');

        // 运行自测
        runSelfTests();
      }

      // 启动
      window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- 开发自测结果（可选可见） -->
    <div id="devTests" class="sr-only" aria-hidden="true"></div>
  </body>
</html>
